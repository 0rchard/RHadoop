## push a file through this to get as many partitions as possible (depending on system settings)
## data is unchanged

scatter = function(input, output = NULL, vectorized = FALSE, ...)
  mapreduce(input, 
            output, 
            map = function(k, v) keyval(sample(1:1000, 1), keyval(k, v, vectorized)), 
            reduce = function(k, vv) vv)

gather = function(input, output = NULL, ...) {
  backend.parameters = list(...)['backend.prameters']
  backend.parameters$hadoop = append(backend.parameters$hadoop, list(D='mapred.reduce.tasks=1'))
  mapreduce(input,
            output, 
            backend.parameters = backend.parameters,
            ...)}
            
            ##optimizer

is.mapreduce = function(x) {
  is.call(x) && x[[1]] == "mapreduce"}

mapreduce.arg = function(x, arg) {
  match.call(mapreduce, x) [[arg]]}

optimize = function(mrex) {
  mrin = mapreduce.arg(mrex, 'input')
  if (is.mapreduce(mrex) && 
    is.mapreduce(mrin) &&
    is.null(mapreduce.arg(mrin, 'output')) &&
    is.null(mapreduce.arg(mrin, 'reduce'))) {
    bquote(
      mapreduce(input =  .(mapreduce.arg(mrin, 'input')), 
                output = .(mapreduce.arg(mrex, 'output')), 
                map = .(compose.mapred)(.(mapreduce.arg(mrex, 'map')), 
                                        .(mapreduce.arg(mrin, 'map'))), 
                reduce = .(mapreduce.arg(mrex, 'reduce'))))}
  else mrex }


##other

reload = function() {
  detach("package:rmr", unload=T)
  library.dynam.unload("rmr",system.file(package="rmr"))
  library(rmr)}
